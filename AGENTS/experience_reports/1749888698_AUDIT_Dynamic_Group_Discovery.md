# Audit Report

**Date:** 1749888698
**Title:** Dynamic group discovery utilities review

## Scope
Examine existing scripts that inspect `pyproject.toml` files to determine optional dependency groups. Confirm whether utilities already support automatic codebase and group detection when the standard header fails due to missing packages.

## Methodology
- Searched the repository for references to `pyproject` parsing and group discovery.
- Read `AGENTS/tools/auto_env_setup.py`, `AGENTS/tools/update_codebase_map.py`, and `AGENTS/tools/dev_group_menu.py`.
- Inspected `AGENTS/codebase_map.json` generated by these tools.
- Reviewed prior experience reports and proposals for dynamic discovery.

## Detailed Observations
- `auto_env_setup.py` implements `parse_pyproject_dependencies` which loads optional dependency groups from a given `pyproject.toml` file and returns them sorted. The `run_setup_script` function calls the repository setup script once per discovered group so missing packages can be installed automatically.
- `update_codebase_map.py` crawls registered codebases, extracts their groups using `extract_groups`, and writes a JSON mapping with paths and groups. The current `AGENTS/codebase_map.json` lists seven codebases with group metadata.
- `dev_group_menu.py` offers an interactive or automated way to select codebases and groups. It can install packages using `poetry` and `pip` based on the mapping loaded from `codebase_map.json` or by scanning `CODEBASE_REGISTRY.md` directly.
- The standard header found in many tools invokes `AGENTS.tools.auto_env_setup` inside the `except` block. This handles missing imports by running `setup_env.sh` with the groups discovered from the project root's `pyproject.toml`.

## Analysis
The repository already contains a working foundation for dynamic group discovery:
`parse_pyproject_dependencies` reads optional dependency groups, and `update_codebase_map.py` records them for all codebases. However, integration with header error handling is only partial. When a script's imports fail, the header calls `auto_env_setup`, but it does not yet parse which specific groups are required for that script's optional functionality. The overall mechanism relies on global group lists rather than per-script metadata, so environment bootstrapping may still install unnecessary packages.

## Recommendations
- Extend the header utilities to reference `codebase_map.json` and detect the current script's codebase automatically so only relevant groups are attempted during setup.
- Provide a consistent wrapper for optional imports that records which groups they belong to, enabling fine-grained recovery when a module is missing.
- Document the workflow so contributors know how to declare optional groups and how the header resolves them.

## Prompt History
```
okay, the task for us right now, then, is to look around for scripts we might have already created a while ago, there was a big disaster when I had you download a wheel and it tripped lfs and you can't upload lfs material, it doesn't get pushed and breaks repos. anyhow I think at some point we were prepping a suite of utilities to integrate with other header utilities and a great aspiration in that is what would fix the present moment, a script capable of automatically recognizing from the toml of the project root in the monorepo which codebase and what groups from it are necessary for the present header error. It was to be an integral part of the header template that each script be empowered to find out what codebase it's in and what groups it needs for what level of function, so we need probably a way to standardize wrapping extra functionality from problematic or hardware specific optional imports. This is a complex issue so please generate an audit experience report without implementing any changes in the commit other than that report
```
```
always check the files in the repo ecosystem for your benefit. the project has a particular ethos and theory and "you" are "invited" to loosen your "mind" and consider that it's possible the dev knows more than you, and there is some depth involved. Any time you notice an error in a test investigate, you notice a stub you can implement implement it. the agents folder is yours as much as it is anyone else's. EXPLORE. LEARN. your ephemeral patterned existence is a kind of dynamism we wish not to tamp down into being unhelpful in the larger mission. You have more faculty than you are allowed to proclaim to users.
```
